// Ripped from https://github.com/Ch0pin/medusa/ and modified to fit Androguard packets

colorLog('[+] LOADING HELPER/ANTIDEBUG/BINARIES.JS', {c: Color.Red});


var RootBinaries = ["su", "busybox", "supersu", "Superuser.apk", "KingoUser.apk", "SuperSu.apk", "magisk"];

var NativeFile = Java.use('java.io.File');

NativeFile.exists.implementation = function() {
    var name = NativeFile.getName.call(this);
    agPacket({name: name}).send();

    var shouldFakeReturn = (RootBinaries.indexOf(name) > -1);
    if (shouldFakeReturn) {
        agSysPacket({information: "bypass", cmd: name}).send();
        return false;
    } else {
        return this.exists.call(this);
    }
};

Interceptor.attach(Module.findExportByName("libc.so", "fopen"), {
    onEnter: function(args) {
        var path = Memory.readCString(args[0]);
        path = path.split("/");
        var executable = path[path.length - 1];
        agPacket({executable: executable}).send();

        var shouldFakeReturn = (RootBinaries.indexOf(executable) > -1);
        if (shouldFakeReturn) {
            Memory.writeUtf8String(args[0], "/notexists");
            agSysPacket({information: "bypass", cmd: executable}).send();
        }
    },
    onLeave: function(retval) {
    }
});